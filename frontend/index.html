<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人脸识别系统</title>
    <style>
        :root {
            --bg-color: #08090a;
            --card-bg: #141517;
            --card-border: #242628;
            --text-primary: #ededed;
            --text-secondary: #8a8f98;
            --accent: #5e6ad2;
            --accent-glow: rgba(94, 106, 210, 0.3);
            --danger: #e5484d;
            --success: #30a46c;
            --spotlight-color: rgba(255, 255, 255, 0.08);
            --border-radius: 12px;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 40px 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px; /* 稍微加宽一点以容纳一行6个 */
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 60px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: 12px;
            background: linear-gradient(to bottom right, #fff, #8a8f98);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.05em;
        }

        /* Layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        /* Card Styles */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            padding: 32px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.3s;
            width: 100%;
        }

        /* Spotlight Card Effect */
        .card::before {
            content: "";
            position: absolute;
            height: 100%;
            width: 100%;
            top: 0;
            left: 0;
            background: radial-gradient(
                800px circle at var(--mouse-x) var(--mouse-y),
                var(--spotlight-color),
                transparent 40%
            );
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 1;
        }

        .card::after {
            content: "";
            position: absolute;
            height: 100%;
            width: 100%;
            top: 0;
            left: 0;
            background: radial-gradient(
                600px circle at var(--mouse-x) var(--mouse-y),
                rgba(255, 255, 255, 0.15),
                transparent 40%
            );
            opacity: 0;
            z-index: 1;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        .card:hover::before,
        .card:hover::after {
            opacity: 1;
        }

        .card > * {
            position: relative;
            z-index: 2;
        }

        .card h2 {
            font-size: 1.25em;
            font-weight: 500;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: #1e2023;
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 24px;
            width: fit-content;
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: #2c2e33;
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Upload Area */
        .upload-area {
            border: 1px dashed var(--card-border);
            background: rgba(255, 255, 255, 0.01);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.03);
        }

        .upload-icon {
            margin-bottom: 12px;
            color: var(--text-secondary);
        }
        
        .upload-icon svg {
            width: 32px;
            height: 32px;
        }

        .upload-area p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        input[type="file"] {
            display: none;
        }

        /* Inputs */
        input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            background: #1e2023;
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85em; /* 稍微缩小字体以适应小卡片 */
            margin-bottom: 16px;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
        }

        input[type="text"]:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        /* Buttons */
        button {
            background: var(--text-primary);
            color: var(--bg-color);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }

        button:hover {
            background: #fff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
        }

        button:active {
            transform: translateY(0);
            opacity: 0.9;
        }

        button.secondary {
            background: #2c2e33;
            color: var(--text-primary);
        }
        button.secondary:hover {
            background: #36393f;
            box-shadow: none;
        }

        /* Preview */
        .preview-container {
            margin-top: 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--card-border);
            display: none;
        }
        
        .preview-container:not(:empty) {
            display: block;
        }

        .preview-image {
            width: 100%;
            height: auto;
            display: block;
        }

        /* --- 修改： Detected Faces Grid (用于合照录入) --- */
        /* 改为一行 6 个，自适应 */
        .detected-faces {
            display: grid;
            grid-template-columns: repeat(6, 1fr); /* 强制6列 */
            gap: 8px; /* 间距缩小 */
            margin-top: 24px;
            margin-bottom: 24px;
        }

        /* 小屏幕回退到3列 */
        @media (max-width: 600px) {
            .detected-faces, #batchInputs {
                grid-template-columns: repeat(3, 1fr) !important;
            }
        }

        .detected-face {
            background: #1e2023;
            padding: 6px; /* 缩小内边距 */
            border-radius: 8px;
            border: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .detected-face img {
            width: 100%;
            border-radius: 4px;
            margin-bottom: 6px;
            aspect-ratio: 1;
            object-fit: cover;
        }

        .detected-face input {
            margin-bottom: 0;
            padding: 4px 6px;
            font-size: 0.75em; /* 字体更小 */
            text-align: center;
        }

        /* --- 修改：Batch Input Items (用于批量录入) --- */
        /* 将原本的Flex列表也改为一行6个的Grid */
        #batchInputs {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }

        /* 批量录入的卡片样式调整为垂直布局 */
        .batch-input {
            display: flex;
            flex-direction: column; /* 改为垂直 */
            align-items: center;
            background: #1e2023;
            padding: 6px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
        }
        
        .batch-input img {
            width: 100%; /* 占满格子宽度 */
            height: auto;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 6px;
        }
        
        .batch-input input {
            margin-bottom: 0;
            padding: 4px 6px;
            font-size: 0.75em;
            text-align: center;
        }

        /* Results & Lists */
        .result-container {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--card-border);
        }

        .result-container h3 {
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .face-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .face-item:hover {
            border-color: var(--card-border);
            background: rgba(255,255,255,0.04);
        }

        .face-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--card-border);
        }

        .face-info {
            flex: 1;
        }

        .face-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95em;
        }

        .face-confidence {
            color: var(--text-secondary);
            font-size: 0.8em;
            margin-top: 2px;
        }

        .delete-btn {
            background: transparent;
            color: var(--text-secondary);
            width: auto;
            padding: 8px;
            opacity: 0.7;
        }

        .delete-btn:hover {
            background: rgba(229, 72, 77, 0.1);
            color: var(--danger);
            opacity: 1;
            box-shadow: none;
            transform: none;
        }

        /* Status Messages */
        .success, .error {
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .success {
            background: rgba(48, 164, 108, 0.1);
            color: #4cc38a;
            border: 1px solid rgba(48, 164, 108, 0.2);
        }

        .error {
            background: rgba(229, 72, 77, 0.1);
            color: #ff6369;
            border: 1px solid rgba(229, 72, 77, 0.2);
        }

        /* Stats Grid */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #1e2023;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--card-border);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Loading Spinner */
        .loading {
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--card-border);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Database Actions */
        .db-actions {
            display: flex;
            gap: 12px;
        }

        .db-actions button {
            flex: 1;
        }

        /* --- 新增：Pagination Styles --- */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--card-border);
        }

        .pagination button {
            width: auto;
            padding: 8px 16px;
            font-size: 0.85em;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #2c2e33;
        }

        .page-info {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>人脸识别系统</h1>
            <p>基于深度学习的高精度识别与管理平台</p>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    人脸录入
                </h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('enroll', 'single')">单张录入</button>
                    <button class="tab" onclick="switchTab('enroll', 'batch')">批量录入</button>
                    <button class="tab" onclick="switchTab('enroll', 'group')">合照录入</button>
                </div>

                <div id="enroll-single" class="tab-content active">
                    <div class="upload-area" onclick="document.getElementById('singleFile').click()">
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        </div>
                        <p>点击上传人脸照片</p>
                        <input type="file" id="singleFile" accept="image/*" onchange="handleSingleUpload(event)">
                    </div>
                    
                    <div id="singlePreview" class="preview-container"></div>

                    <input type="text" id="singleName" placeholder="输入姓名">
                    
                    
                    <button onclick="enrollSingle()" id="singleEnrollBtn">确认录入</button>
                    
                    <div id="singleResult"></div>
                </div>

                <div id="enroll-batch" class="tab-content">
                    <div class="upload-area" onclick="document.getElementById('batchFiles').click()">
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                        </div>
                        <p>选择多张照片</p>
                        <input type="file" id="batchFiles" accept="image/*" multiple onchange="handleBatchUpload(event)">
                    </div>
                    
                    <div id="batchInputs"></div>
                    
                    <button onclick="enrollBatch()" id="batchEnrollBtn">批量录入</button>
                    
                    <div id="batchResult"></div>
                </div>

                <div id="enroll-group" class="tab-content">
                    <div class="upload-area" onclick="document.getElementById('groupFile').click()">
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        </div>
                        <p>上传包含多人的合照</p>
                        <input type="file" id="groupFile" accept="image/*" onchange="handleGroupUpload(event)">
                    </div>
                    
                    <div id="groupPreview" class="preview-container"></div>
                    <div id="detectedFaces" class="detected-faces"></div>
                    
                    <button onclick="enrollGroup()" id="groupEnrollBtn" style="display:none;">确认录入</button>
                    
                    <div id="groupResult"></div>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 24px;">
                <div class="card">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        快速识别
                    </h2>
                    
                    <div class="upload-area" onclick="document.getElementById('recognizeFile').click()">
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                        </div>
                        <p>上传待识别照片</p>
                        <input type="file" id="recognizeFile" accept="image/*" onchange="handleRecognizeUpload(event)">
                    </div>
                    
                    <div id="recognizePreview" class="preview-container"></div>
                    
                    <button onclick="recognizeFaces()" id="recognizeBtn">开始识别</button>
                    
                    <div id="recognizeResult"></div>
                </div>

                <div class="card">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        数据库
                    </h2>
                    
                    <div class="stats" id="stats"></div>
                    
                    <div class="db-actions">
                        <button class="secondary" onclick="loadDatabase()">刷新列表</button>
                        <button class="secondary" onclick="clearDatabase()" style="color: var(--danger); background: rgba(229, 72, 77, 0.1);">清空</button>
                    </div>
                    
                    <div id="databaseList" style="margin-top: 24px;"></div>

                    <div class="pagination" id="paginationControls" style="display:none;">
                        <button class="secondary" id="prevBtn" onclick="changePage(-1)">上一页</button>
                        <span class="page-info" id="pageInfo">Page 1 of 1</span>
                        <button class="secondary" id="nextBtn" onclick="changePage(1)">下一页</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Spotlight Effect Script
        function initSpotlight() {
            const cards = document.querySelectorAll('.card');
            document.addEventListener('mousemove', (e) => {
                cards.forEach(card => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    card.style.setProperty('--mouse-x', `${x}px`);
                    card.style.setProperty('--mouse-y', `${y}px`);
                });
            });
        }
        initSpotlight();

        // Original Logic
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000/api'
            : `http://${window.location.hostname}:5000/api`;
        
        let currentImages = {};
        let groupDetectedFaces = [];

        // 新增：数据库分页状态
        let currentDatabaseFaces = [];
        let currentPage = 1;
        const pageSize = 7; // 每页显示数量

        console.log('API URL:', API_URL);

        function switchTab(section, tab) {
            document.querySelectorAll(`#${section}-${tab}`).forEach(el => {
                el.parentElement.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                el.classList.add('active');
            });
            
            const btn = event.target;
            const parent = btn.parentElement;
            parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
        }

        function handleSingleUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImages.single = e.target.result;
                document.getElementById('singlePreview').innerHTML = 
                    `<img src="${e.target.result}" class="preview-image">`;
            };
            reader.readAsDataURL(file);
        }

        function handleBatchUpload(event) {
            const files = Array.from(event.target.files);
            currentImages.batch = [];
            
            const container = document.getElementById('batchInputs');
            container.innerHTML = '';
            
            files.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImages.batch.push(e.target.result);
                    
                    const div = document.createElement('div');
                    div.className = 'batch-input';
                    // 布局改为垂直，适应小格子
                    div.innerHTML = `
                        <img src="${e.target.result}">
                        <input type="text" placeholder="姓名 ${idx + 1}" id="batchName${idx}">
                    `;
                    container.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        async function handleGroupUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                currentImages.group = e.target.result;
                document.getElementById('groupPreview').innerHTML = 
                    `<img src="${e.target.result}" class="preview-image">`;
                
                showLoading('groupResult');
                try {
                    const response = await fetch(`${API_URL}/enroll/group`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: e.target.result })
                    });
                    
                    const data = await response.json();
                    
                    if (data.faces) {
                        groupDetectedFaces = data.faces;
                        displayDetectedFaces(data.faces);
                        document.getElementById('groupEnrollBtn').style.display = 'block';
                        showMessage('groupResult', `检测到 ${data.detected_faces} 张人脸`, 'success');
                    }
                } catch (error) {
                    showMessage('groupResult', '检测失败: ' + error.message, 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        function displayDetectedFaces(faces) {
            const container = document.getElementById('detectedFaces');
            // 此处样式已在 CSS 中改为 Grid 6列
            container.innerHTML = faces.map((face, idx) => `
                <div class="detected-face">
                    <img src="${face.image}">
                    <input type="text" placeholder="姓名" id="groupName${idx}">
                </div>
            `).join('');
        }

        function handleRecognizeUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImages.recognize = e.target.result;
                document.getElementById('recognizePreview').innerHTML = 
                    `<img src="${e.target.result}" class="preview-image">`;
            };
            reader.readAsDataURL(file);
        }

        async function enrollSingle() {
            const name = document.getElementById('singleName').value.trim();
            if (!name || !currentImages.single) {
                showMessage('singleResult', '请上传照片并输入姓名', 'error');
                return;
            }
            
            showLoading('singleResult');
            
            try {
                const response = await fetch(`${API_URL}/enroll/single`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: currentImages.single,
                        name: name
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('singleResult', `成功录入 ${data.name}`, 'success');
                    document.getElementById('singleName').value = '';
                    document.getElementById('singlePreview').innerHTML = '';
                    currentImages.single = null;
                    loadDatabase();
                } else {
                    showMessage('singleResult', data.error, 'error');
                }
            } catch (error) {
                showMessage('singleResult', '录入失败: ' + error.message, 'error');
            }
        }

        async function enrollBatch() {
            if (!currentImages.batch || currentImages.batch.length === 0) {
                showMessage('batchResult', '请上传照片', 'error');
                return;
            }
            
            const names = [];
            for (let i = 0; i < currentImages.batch.length; i++) {
                const name = document.getElementById(`batchName${i}`).value.trim();
                if (!name) {
                    showMessage('batchResult', `请为第 ${i + 1} 张照片输入姓名`, 'error');
                    return;
                }
                names.push(name);
            }
            
            showLoading('batchResult');
            
            try {
                const response = await fetch(`${API_URL}/enroll/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        images: currentImages.batch,
                        names: names
                    })
                });
                
                const data = await response.json();
                
                showMessage('batchResult', 
                    `成功录入 ${data.success_count}/${data.total} 张`, 
                    data.success_count === data.total ? 'success' : 'error');
                
                if (data.success_count === data.total) {
                    document.getElementById('batchInputs').innerHTML = '';
                    currentImages.batch = [];
                    loadDatabase();
                }
            } catch (error) {
                showMessage('batchResult', '批量录入失败: ' + error.message, 'error');
            }
        }

        async function enrollGroup() {
            const names = [];
            for (let i = 0; i < groupDetectedFaces.length; i++) {
                const name = document.getElementById(`groupName${i}`).value.trim();
                if (!name) {
                    showMessage('groupResult', `请为第 ${i + 1} 张脸输入姓名`, 'error');
                    return;
                }
                names.push(name);
            }
            
            showLoading('groupResult');
            
            try {
                const response = await fetch(`${API_URL}/enroll/group`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: currentImages.group,
                        names: names
                    })
                });
                
                const data = await response.json();
                
                showMessage('groupResult', 
                    `成功录入 ${data.success_count}/${data.total} 张`, 
                    data.success_count === data.total ? 'success' : 'error');
                
                if (data.success_count === data.total) {
                    document.getElementById('detectedFaces').innerHTML = '';
                    document.getElementById('groupPreview').innerHTML = '';
                    document.getElementById('groupEnrollBtn').style.display = 'none';
                    currentImages.group = null;
                    loadDatabase();
                }
            } catch (error) {
                showMessage('groupResult', '合照录入失败: ' + error.message, 'error');
            }
        }

        async function recognizeFaces() {
            if (!currentImages.recognize) {
                showMessage('recognizeResult', '请上传照片', 'error');
                return;
            }
            
            showLoading('recognizeResult');
            
            try {
                const response = await fetch(`${API_URL}/recognize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: currentImages.recognize,
                        threshold: 0.6
                    })
                });
                
                const data = await response.json();
                
                if (data.detected_faces === 0) {
                    showMessage('recognizeResult', '未检测到人脸', 'error');
                } else {
                    displayRecognitionResults(data.results);
                }
            } catch (error) {
                showMessage('recognizeResult', '识别失败: ' + error.message, 'error');
            }
        }

        function displayRecognitionResults(results) {
            const container = document.getElementById('recognizeResult');
            container.innerHTML = `
                <div class="result-container">
                    <h3>识别结果 (${results.length})</h3>
                    ${results.map(r => `
                        <div class="face-item">
                            <div class="face-info">
                                <div class="face-name">${r.name}</div>
                                <div class="face-confidence">
                                    ${r.recognized ? `置信度: ${(r.confidence * 100).toFixed(1)}%` : '未识别'}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- Modified Database Logic for Pagination ---

        async function loadDatabase() {
            try {
                const response = await fetch(`${API_URL}/database/list`);
                const data = await response.json();
                
                // Update stats
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${data.total}</div>
                        <div class="stat-label">Total Faces</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${new Set(data.faces.map(f => f.name)).size}</div>
                        <div class="stat-label">Unique People</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #30a46c">OK</div>
                        <div class="stat-label">System</div>
                    </div>
                `;
                
                // Store data globally and reset to page 1
                currentDatabaseFaces = data.faces;
                currentPage = 1;
                renderDatabaseList();

            } catch (error) {
                console.error('加载数据库失败:', error);
            }
        }

        function renderDatabaseList() {
            const list = document.getElementById('databaseList');
            const paginationControls = document.getElementById('paginationControls');

            if (currentDatabaseFaces.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:var(--text-secondary); padding: 20px;">数据库为空</p>';
                paginationControls.style.display = 'none';
                return;
            }

            // Calculate start and end indices
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = currentDatabaseFaces.slice(start, end);
            const totalPages = Math.ceil(currentDatabaseFaces.length / pageSize);

            // Render List
            list.innerHTML = pageData.map(face => `
                <div class="face-item">
                    ${face.image ? `<img src="${face.image}">` : '<div style="width:40px;height:40px;background:#2c2e33;border-radius:50%;"></div>'}
                    <div class="face-info">
                        <div class="face-name">${face.name}</div>
                        <div class="face-confidence">${face.timestamp.split('T')[0]}</div>
                    </div>
                    <button class="delete-btn" onclick="deleteFace('${face.face_id}')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            `).join('');

            // Update Pagination Controls
            if (totalPages > 1) {
                paginationControls.style.display = 'flex';
                document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prevBtn').disabled = currentPage === 1;
                document.getElementById('nextBtn').disabled = currentPage === totalPages;
            } else {
                paginationControls.style.display = 'none';
            }
        }

        function changePage(direction) {
            currentPage += direction;
            renderDatabaseList();
        }

        async function deleteFace(faceId) {
            if (!confirm('确定要删除这张人脸吗？')) return;
            
            try {
                await fetch(`${API_URL}/database/delete/${faceId}`, {
                    method: 'DELETE'
                });
                loadDatabase();
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        async function clearDatabase() {
            if (!confirm('确定要清空整个数据库吗？此操作不可恢复！')) return;
            
            try {
                await fetch(`${API_URL}/database/clear`, {
                    method: 'DELETE'
                });
                loadDatabase();
            } catch (error) {
                alert('清空失败: ' + error.message);
            }
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            const icon = type === 'success' 
                ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
            element.innerHTML = `<div class="${type}">${icon} ${message}</div>`;
        }

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '<div class="loading"><div class="spinner"></div><p>处理中...</p></div>';
        }

        window.onload = () => {
            loadDatabase();
        };
    </script>
</body>
</html>